# 复制
> 数据复制多个副本到其他机器，满足故障恢复和负载均衡等需求。复制时高可用的基础。 

## 配置
### 建立复制
- 默认都是主节点，主节点可以同时具有多个从节点。 
- 复制时单向的，只能从主节点到从节点。 

#### 配置方式
1. 修改配置文件，从节点配置文件中加入`replicaof {masterHost} {masterPort}`
2. 启动命令加入 `-replcaof {masterHost} {masterPort}`
3. 客户端中使用命令 `replciaof {masterHost} {masterPort}`

> 配置完成之后主节点所有修改都可以同步到从节点。   
> replicaof命令是异步的，节点只保存主节点信息之后返回，后续复制命令在节点内部异步执行。   
> 通过`info replication`命令查看复制相关状态      
    
```bash
127.0.0.1:6400> info replication
# Replication
role:master                         # 主节点
connected_slaves:2                  # 连接从节点个数
slave0:ip=127.0.0.1,port=6401,state=online,offset=91658,lag=1     # 从节点信息
slave1:ip=127.0.0.1,port=6402,state=online,offset=91658,lag=1     
master_failover_state:no-failover
master_replid:cb813ba385805b0ce3f2df4aa79b301aedd735e5
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:91658
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:91658
```
### 断开复制  
- slaveof命令不但可以用于建立连接，还可以用来断开连接。断开连接使用命令`slaveof no one`。  
  从节点断开连接之后不会丢失原来复制的数据，只是不能再从原来主节点复制数据。   
  断开复制流程：
  1. 断开与主节点复制关系。  
  2. 从从节点晋升为主节点。   
- slaveof命令还可以实现切主操作。`slaveof {newMasterHost} {newMasterPort}`  
  切主操作流程: 
  1. 断开旧主节点复制关系。  
  2. 与新主节点建立复制关系。 
  3. 删除当前从节点中所有数据。  
  4. 对新主节点进行复制操作。  

### 安全性
1. 主节点通过`requrepass`配置设置命令之后，所有客户端访问都必须使用密码。  
2. 从节点配置`masterauth`，参数为主节点密码，这样从节点才可以正确连接到主节点。    

### 只读   
> 默认情况下，从节点使用`replica-read-only`配置为只读模式，由于主从复制是单向的，
> 从节点所有操作在主节点上无法感知，为了避免主从节点数据不一致，线上环境不建议修改。  


## 拓扑
1. 一主一从结构    
    ![img.png](images/一主一从.png)
   > 最简单的复制拓扑结构，用于主节点宕机时从节点提供故障转移。    
   > 可以只在从节点开启AOF，既保证数据安全性，又可以避免持久化对主节点性能的干扰。
   > 主节点脱机自动重启会导致从节点数据也被清空。如果主节点宕机，可以先通过slaveof no one断开连接之后再重启。    
2. 一主多从结构   
   ![img.png](images/一主多从.png)    
   > 利用多个节点实现读写分离。   
   > 主节点写命令多次发送过度消耗网络带宽   
   > 加重主节点负载影响服务稳定性。   
3. 树状主从结构   
   ![img.png](images/树状主从结构.png)
   > 从节点不但可以复制主节点的内容，还可以当作其他从节点的主节点继续向下复制。   
   > 通过引入复制中间层降低负载以及传送给从节点的数据量。   
   >  

## 原理
![img.png](images/主从复制原理.png)
1. 保存主节点信息
2. 主从建立socket连接
3. 发送ping命令
4. 权限验证
5. 同步数据集
6. 命令持续复制

### 数据同步
- 全量复制
  ![img.png](images/全量复制.png)
  - 1. 发送psync进行数据同步，由于第一次复制，从节点中没有保存主节点的id以及偏移量，使用`psync ? -1`
    2. 根据命令解析出当前为全量复制，回复FULLRESYNC相应
    3. 从节点接受并保存主节点的id以及偏移量
    4. 主节点执行`bgsave`命令保存RDB文件到本地。 
    5. 主节点发送RDB文件到从节点，从节点接受并把RDB文件作为本地持久化文件，数据量过大的时候可能会导致失败，可以调整`repl_timeout`增加超时时间。
    6. 从节点接收RDB文件过程中主节点依然接受写入并保存到缓冲区，从节点接收完RDB文件之后主节点发送缓冲区数据给从节点。
    7. 从节点清空自身旧数据
    8. 从节点加载RDB文件
    9. 从节点如果开启了AOF会立即做bgrewriteaof操作，保证全量复制之后AOF持久化文件立即可用。  
- 部分复制
  

- `psync`命令支持
  - 主从节点各自复制偏移量     
    > 主从节点都会保存双方偏移量 `master_repl_offset`以及`slave_repl_offset`, 根据主从节点偏移量比较可以判断主从节点数据是否一致。   
  - 主节点复制积压缓存区
    > 默认1M，主节点有连接的从节点时创建， 这时主节点相应写命令时，不但会发送给从节点，还会写入积压缓冲区。先进先出的定长队列，只能保存最近复制数据吗，用于丢失数据补救。
  - 主节点运行id
    > 识别从节点复制的是哪个主节点。Redis关闭重启之后会发生变化。   
  - psync命令， `psync {runId} {offset}`

