# Redis基础

## Redis简介
 > Redis是`Salvatore Sanfilippo`使用C语言编写的完全开源的key-value存储数据库，遵守BSD协议。       
 
 ### Redis的特点
 1. 支持数据持久化，可以将内存中的数据持久化到磁盘中，重启的时候加载进内存再次使用；    
 2. 不仅仅支持简单的字符串(String)类型，还支持列表(list)、哈希(Hash)、集合(Set)、有序集合(ZSet)；   
 3. 支持master-slave模式的数据备份。


 ### Redis的优势
 1. 性能高---Redis的读的速度110000次/秒，写速度是81000次/秒；  
 2. 丰富的数据类型---支持String、List、Set、Hash、ZSet类型；
 3. 原子性---Redis所有的操作都是原子性的。
 4. 丰富的特性---支持订阅/发布、通知、key过期等特性。 

 ### 应用场景  
 1. 缓存
    > 加快数据的访问速度，并且可以有效的降低后端数据源的压力。同时Redis提供了键过期时间设置，同时也提
    > 供了灵活控制最大内存和内存溢出后的淘汰策略。 
 2. 排行榜系统
    > Redis提供了列表以及有序集合数据结构，合理使用这些数据结构可以很方便的构建排行榜系统。
 3. 计数器应用
    > Redis支持自增且性能好，是计数器系统的重要选择。
 4. 社交网络
    > Redis提供的数据结构可以很方便的实现点赞/踩、共同好友/爱好、推送等等社交网络的必备功能。
 5. 消息队列
    > Redis可以实现简单的消息队列功能。   
    
 ## Redis安装
 由于Redis官方不支持windows，安装默认Linux，版本选择6.2.10。
 ```bash
 # 下载Redis
 [root@study masq]$ wget https://download.redis.io/releases/redis-6.2.10.tar.gz
 # 解压
 [root@study masq]$ tar -zxvf redis-6.2.10.tar.gz  
 # 编译（必须先安装gcc）
 [root@study masq]$ cd redis-6.2.10
 [root@study redis-6.2.10]$ make
 # 安装
 [root@study redis-6.2.10]$ make install   # 安装到默认位置 /usr/local/bin
 [root@study redis-6.2.10]$ make install PREFIX=/path/redis  # 安装到指定位置 
 
 # Redis启动
 [root@study redis-6.2.10]$ cd /path/redis/bin
 [root@study bin]$ ./redis-server   # 默认配置启动
 [root@study bin]$ ./redis-server /configPath/redis.conf   # 指定配置未见启动  
 
 # 客户端连接Redis
 [root@study bin]$ ./redis-client -h {HOST} -p {PORT} -a {PASSWORD} 
 ```

## Redis配置
1. `daemonize no`: Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程   
2. `pidfile /var/run/redis.pid`: 当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件中，可以通过pidfile指定。
3. `port 6379`: Redis默认监听端口为6379，修改此项可以更改监听端口。
4. `bind 127.0.0.1`: 绑定的主机地址。
5. `timeout 300`: 客户端闲置多长时间后关闭连接，如果指定为0则关闭该功能。
6. `loglevel notice`: 指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning。
7. `logfile ""`: 指定日志文件名。空字符串也可以用来强制Redis登录到标准输出。注意，如果使用标准输出进行日志记录，但是使用daemonize，那么日志将被发送到/dev/null。
8. `databases 16`: 设置数据库数量。
9. `save <seconds> <changes>`: 指定多长时间有多少次更新就将数据持久化到磁盘
10. `rdbcompression yes`: 指定持久化数据时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，可以关闭该选项，但会导致数据库文件变的巨大。
11. `dbfilename dump.rdb`:  指定持久化到本地的文件名
12. `dir ./`: 指定持久化文件存储的目录。
13. `slaveof <masterip> <masterport>`: 设置本机为slave时，指定master服务的ip以及端口。
14. `masterauth <master-password>`: 当master节点设计密码保护的时候，slave连接master使用的密码。
15. `requirepass foobared`: 设置Redis的连接密码。
16. `maxclients 10000`: 设置同一时间客户端的最大连接数。当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息。
17. `maxmemory <bytes>`: 指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis新的vm机制，会把Key存放内存，Value会存放在swap区。
18. `apendonly no`: 是否开启aof，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no。
19. `appendfilename "appendonly.aof"` 指定aof日志文件名。
20. `appendfsync everysec` aof更新频率。
    - no: 表示等操作系统进行数据缓存。（快）
    - always: 每次跟新后手动调用fsync将数据写入磁盘。（慢、安全）
    - everysec: 每秒同步一次。
21. `include /path/to/local.conf`: 指定包含的其他配置文件，可以将一些共性的配置放入此文件中，个性的配置分别配置到各自的配置文件中。

## Redis命令与数据结构
### 常用全局命令
```redis
# 删除一个或多个键，返回被删除的键的个数。时间复杂度O(N)，N为删除的键的个数。
DEL key [key...]
# 序列化给定的key，并返回序列化的值。使用RESTORE命令可以将序列化的值反序列化为Redis键。如果键不存在则返回nil，如果存在则返回序列化之后的值。
DUMP key
# 反序列化给定的序列
RESTORE key ttl serialized-value
# 检查键是否存在。存在返回1，反之则为0。时间复杂度O(1)
EXISTS key
# 给key设置过期时间，单位为秒。成功返回1，如果key不存在或者不能设置过期时间则返回0。时间复杂度O(1)。
EXPIRE key seconds 
# 给key设置具体的过期时间，指定在某个时间戳过期。成功返回1，如果key不存在或者不能设置过期时间则返回0。时间复杂度O(1)。
EXPIREAT key timestamp
# 同EXPIRE，不同的是设置的时间单位为毫秒
PEXPIRE key milliseconds
# 同EXPIREAT，不同的是设置的时间戳单位为毫秒
PEXPIREAT key milliseconds-timestamp
# 查找符合格式的键，返回给定格式的键的列表。会造成性能问题，建议不要使用。
KEYS pattern
# 原子性的迁移key到指定的数据库上，COPY不删除本实例的key，REPLACE删除本实例的键，成功返回OK，失败则返回对应的错误信息。
MIGRATE host port key distination-db timeout [COPY] [REPLACE] 
# 将当前数据库中的key移动到指定的db中。成功返回1，失败则返回0。
MOVE key db
# 移除指定key的过期时间，使其从易失状态变为持久状态。移除成功返回1，如果 key 不存在或 key 没有设置生存时间，返回 0
PERSIST key
# 返回key的过期时间，单位为秒。不存在返回-2， 存在但没有设置过期时间返回-1
TTL key 
# 同TTL，不过单位为毫秒
PTTL key
# 随机返回一个key，数据库为空时返回nil
RANDOMKEY 
# 重命名，成功返回OK，失败返回具体错误
RENAME name newName 
# 当且仅当存在时返回重命名，成功返回1，失败返回0
RENAMENX name newName
# 返回key中存储的值类型
TYPE key
# 返回当前数据库中key的总和
DBSIZE 
```

### 字符串(String)
> 字符串是Redis中最基础的数据结构，其他集中类型都是在字符串的基础上创建的，字符串的值类型可以是简单的字符串、复杂的字符串(json、xml等)、数字，甚至可以是二进制(图片、音视频)，但是值最大不能超过512M

#### 常用命令  

- 写入
  ```redis
  # 单个设置， 参数EX、PX、EXAT、PXAT设置过期时间， NX表示不存在才可以设置成功，XX相反，存在才可以设置成功
  SET key value [EX seconds|PX milliseconds|EXAT timestamp|PXAT milliseconds-timestamp|KEEPTTL] [NX|XX] [GET]
  # 如果key不存在，则设置key的值为value
  SETNX key value
  # 批量设置字符串类型的键值对
  MSET key value [key value ...]
  # 批量设置，如果不存在才可以设置成功
  MSETNX key value [key value ...]
  # 设置key-value，同时设置过期时间，单位为秒
  SETEX key seconds value
  # 设置key-value，同时设置过期时间，单位为毫秒
  PSETEX key milliseconds value
  # 指定key设置新值并返回旧值
  GETSET key value
  # 指定key的value数值加一，如果key不存在则按照0自增，如果key的value不是数字类型，则返回一个错误信息
  INCR key
  # 指定key的value数值减一，如果key不存在则按照0减少，如果key的value不是数字类型，则返回一个错误信息
  DECR key
  # 同INCR，递增的数值为指定的整数
  INCRBY key increment
  # 同DECR，递减的数值为指定的整数
  DECRBY key decrement
  # 同INCRBY，增加的值为浮点数
  INCRBYFLOAT key increment
  # 用value复写key所存储的值指定偏移量上面的字符串
  SETRANGE key offset value
  # 向指定key追加value，如果不存在key则设置，返回追加后的长度
  APPEND key value
  ```
- 读取
  ```redis
  # 读取单个key的value
  GET key
  # 读取多个key的value
  MGET key [key ...]
  # 获取指定key在某个偏移量阶段的字符串，可以为负数，-1为最后一个字符，-2为倒数第二个字符
  GETRANGE key start end
  # 读取指定key的value的长度
  STRLEN key
  ```

#### 内部编码
> 字符串的内部编码包含下面三种：
> 1. `int`: 8个字节的长整型
> 2. `embstr`: 小于等于39个字节的字符串 
> 3. `raw`: 大于等于39个字节的字符串